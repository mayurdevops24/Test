name: Mayur

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Project identifier'
        required: true
      verbosity:
        description: 'Logging verbosity level (info, debug, error)'
        required: false
        default: 'info'
  repository_dispatch:
    types: [trigger-instance]

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      start-time: ${{ steps.start-time.outputs.time }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Capture start time
        id: start-time
        run: echo "time=$(date +%s)" >> "$GITHUB_OUTPUT"

  action-one:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare logs directory for Action One
        run: |
          ACTION_LOG_DIR="logs/action-one"
          mkdir -p "$ACTION_LOG_DIR"

      - name: Run Action One and log details
        id: action-one
        run: |
          ACTION_LOG_DIR="logs/action-one"
          LOG_FILE="$ACTION_LOG_DIR/action-one-details.log"
          mkdir -p "$ACTION_LOG_DIR"
          {
            echo "--- Action One Log ---"
            echo "Project: ${{ github.event.inputs.project }}"
            echo "Run ID: ${{ github.run_id }}"
            echo "Action: action-one"
            echo "Status: Running"
            echo "Start Time: $(date)"
            echo "Processing Action One..."
            echo "End Time: $(date)"
            echo "Status: Completed"
          } | tee "$LOG_FILE"
        continue-on-error: false

      - name: Upload Consolidated Log File
        uses: actions/upload-artifact@v4
        with:
          name: action-one-details
          path: logs/action-one/action-one-details.log

  finalize:
    runs-on: ubuntu-latest
    needs: [setup, action-one]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Consolidated Log Artifact
        uses: actions/download-artifact@v4
        with:
          name: action-one-details

      - name: Append timing and metadata to log file
        run: |
          LOG_FILE="logs/action-one/action-one-details.log"
          end_time=$(date +%s)
          start_time="${{ needs.setup.outputs.start-time }}"
          duration=$((end_time - start_time))

          {
            echo "--- Workflow Timing ---"
            echo "Workflow Start Time: $(date -d @$start_time)"
            echo "Workflow End Time: $(date -d @$end_time)"
            echo "Total Duration: ${duration}s"
            echo "--- Metadata ---"
            echo "Project: ${{ github.event.inputs.project }}"
            echo "Run ID: ${{ github.run_id }}"
            echo "Status: ${{ job.status }}"
            echo "Triggered by: ${{ github.triggering_actor }}"
            echo "Verbosity Level: ${{ github.event.inputs.verbosity }}"
          } >> "$LOG_FILE"

      - name: Re-upload Final Consolidated Log
        uses: actions/upload-artifact@v4
        with:
          name: action-one-details
          path: logs/action-one/action-one-details.log

      - name: Live Logging with Verbosity
        if: ${{ github.event.inputs.verbosity == 'debug' }}
        run: |
          LOG_FILE="logs/action-one/action-one-details.log"
          echo "--- Live Log Preview ---"
          cat "$LOG_FILE"

  status-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'repository_dispatch'
    steps:
      - name: Download Consolidated Log
        uses: actions/download-artifact@v4
        with:
          name: action-one-details

      - name: Display Instance Status
        run: |
          LOG_FILE="logs/action-one/action-one-details.log"
          if [ -f "$LOG_FILE" ]; then
            echo "--- Retrieved Log Content ---"
            cat "$LOG_FILE"
          else
            echo "No log found for the provided Run ID."
          fi
